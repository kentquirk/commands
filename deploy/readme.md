# deploy

This folder contains files that are used in circle for building and testing all of the go source code. It follows an earlier method of building in containers.

* `deps.docker` - this docker image downloads dependencies, so other subsequent images don't have to repeat the process.
* `.../docker-build-push.sh` - these scripts build and upload images to ECR.

## Other files

`known_hosts` - This file is generated by running the command: `ssh-keyscan -t rsa github.com`. The output of which can be directly stored into ~/.ssh/known_hosts. Any difference between what is stored here will be rejected by dep when attempting to clone dependencies.

## circle ci builds

There are three modes regarding git tags and git branches that are captured in `./circleci/config.yml`, and each triggers different actions.

Firstly, all commits run the deps and test jobs.

Secondly, tagged builds respond to commits that are tagged. They can be tagged with either `.*-push`, in which case it will push an built docker image to ECR. They can be tagged with `.*-deploy` in which case it will deploy to devnet.

The third case is a commit to master, this will run all steps and deploy to devnet as if it were tagged `something-deploy`.

## caveat

Since the `deps` image sticks around, there are commits in that image that contain a copy of our `machine_user_key`. Care must be taken to not expose this key. This is prevented by two measures 1) never uploading the `deps` image anywhere and 2) never copying the key out of the container to another container. The image itself is always built where it is used. It is no more exposed than the key file sitting on your machine and `docker rmi deps` removes it entirely.

## VSCode file associations

We have to deal with the fact that "dockerfiles" eschew the industry standard practice of file extensions. By convention, the docker files in this repository are suffixed with ".docker". You can configure VSCode to associate *.docker files with the following user setting:

```json
    "files.associations": {
        "*.docker":"dockerfile"
    },
```
