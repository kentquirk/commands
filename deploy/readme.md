# deploy

This folder contains everything that needs to be built and put into ECR for deployment.

* `deps.docker` - downloads dependencies
* `.../docker-build-push.sh` - these files build and upload images to ECR.
* `deploy.sh` - redeploys the testnet.

## Folders

* `chaos` contains everything relating to the chaosnode's image.
* `ndau` contains everything relating to the ndaunode and ndauapi image.

## Other files

`known_hosts` - This file is generated by running the command: `ssh-keyscan -t rsa github.com`. The output of which can be directly stored into ~/.ssh/known_hosts. Any difference between what is stored here will be rejected by dep when attempting to clone dependencies.
`noms/noms.docker` - Dockerfile for our NomsDB image.
`tendermint/tendermint.docker` - Dockerfile for our Tendermint image.


## docker files

These files are organized in a way that allows dependencies to be downloaded once, and then passed around for multiple builds.

In the CircleCI environment, for example, this means you `go ensure deps` one time, and then build for chaosnode, ndaunode, and ndauapi.

## caveat

Since the `deps` image sticks around, there are commits in that image that contain a copy of our `machine_user_key`. Care must be taken to not expose this key. This is prevented by two measures 1) never uploading the `deps` image anywhere and 2) never copying the key out of the container to another container. The image itself is always built where it is used. It is no more exposed than the key file sitting on your machine and `docker rmi deps` removes it entirely.

## VSCode file associations

We have to deal with the fact that "dockerfiles" eschew the industry standard practice of file extensions. By convention, the docker files in this repository are suffixed with ".docker". You can configure VSCode to associate *.docker files with the following user setting:

```json
    "files.associations": {
        "*.docker":"dockerfile"
    },
```
