# Build stage: this all gets discarded later
FROM golang:1.10-alpine3.7

# start by installing fundamental utilities
# openssh-client is required for git
# git is required for glide
# bash is required for check-github-fingerprint.sh (array syntax)
RUN apk add --no-cache git openssh-client bash

ARG SSH_KEY_FILE="machine_user_key"
COPY ${SSH_KEY_FILE} /root/.ssh/id_rsa
COPY ./bin/check-github-fingerprint.sh /root/
RUN /root/check-github-fingerprint.sh
RUN chmod 0600 /root/.ssh/*

# now install glide, which both tendermint and ndev-developed software
# use for dependency management
RUN go get github.com/Masterminds/glide

# Copy the context into the container and build the chaos application
ENV CHAOS=$GOPATH/src/github.com/oneiro-ndev/chaos
COPY ./pkg ${CHAOS}/pkg
COPY ./cmd ${CHAOS}/cmd
COPY ./glide.* ${CHAOS}/
WORKDIR ${CHAOS}
# note the concatenated command here. This is a special case:
# we want to be absolutely sure that "glide install" doesn't use a cached version
# when we build the app, so we &&-concatenate the commands.
RUN git config --global url.git@github.com:.insteadof https://github.com/ && \
    glide install && \
    go test ./...
